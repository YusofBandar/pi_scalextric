<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xmlns:p="http://www.evolus.vn/Namespace/Pencil" xmlns:html="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>track_schematic</title><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="apple-mobile-web-app-capable" content="yes" /><meta name="apple-mobile-web-app-status-bar-style" content="translucent black" /><link rel="apple-touch-icon-precomposed" href="Resources/images/icon_57x57.png" /><link rel="apple-touch-icon-precomposed" sizes="72x72" href="Resources/images/icon_72x72.png" /><link rel="apple-touch-icon-precomposed" sizes="114x114" href="Resources/images/icon_114x114.png" /><link rel="apple-touch-icon-precomposed" sizes="144x144" href="Resources/images/icon_144x144.png" /><link rel="icon" type="image/png" href="Resources/images/favicon.png" /><link rel="stylesheet" type="text/css" href="Resources/style.css" /><script type="text/javascript" src="Resources/lib.js">
                    //
                </script></head><body><div class="page" id="start"><img src="pages/start.png" width="1024" height="768" usemap="#map_start" /><div class="notes"><span class="open control" title="Show Notes">Ξ</span><span class="pin control" title="Pin Notes">∞</span><span class="close control" title="Hide Notes">×</span><div class="content"><div><span style="font-weight: bold;">Raspberry Pi and Grove Sensor Board</span><div>2 x Light Sensors (Red) : Sense car position at start/finish</div><div>2 x DC Current Sensors (Green): Sense current draw from cars<div><br /><br /></div><div>Running Node-RED, to handle connectivity to MQTT</div></div><div>Running Python, to handle incoming sensor data, and threshold triggering</div><div><br /><br /></div><div><span style="font-weight: bold;">Power Electronics </span>(see inset)</div><div>convert low current digital output from PWM output, to high current 16v output for running DC Motors.</div><div><br /><br /></div><div><span style="font-weight: bold;">MQTT</span></div><div>Mosquitto MQTT broker running on Heroku service</div><div><br /><br /></div><div><span style="font-weight: bold;">GitHub Pages</span></div><div>Static site server, running on GitHub infrastructure</div><div><br /><br /></div><div><span style="font-weight: bold;">Monitor</span></div><div>Shows QR code, which contains URL to GitHub Pages, Single Page Web Application</div><div>Parameters show URL of MQTT server, username / password for the service, UUID of RPi installation.</div><div><br /><br /></div><div><span style="font-weight: bold;">Mobile Phones</span></div><div>Running recent smartphone OS - camera will automatically scan the QR code, and download SPWA from GitHub Pages.</div><div><br /><br /></div><div><span style="font-weight: bold;">SPWA</span></div><div>Single Page Web App, served from Github Pages, connects with MQTT using URL parameters.</div><div><br /><br /></div><div><span style="font-weight: bold;">1up</span></div><div>Instance of SPWA on player 1's smart phone</div><div><br /><br /></div><div><div style="font-size: 13.3333px;"><span style="font-weight: bold;">2up</span></div><div style="font-size: 13.3333px;">Instance of SPWA on player 2's smart phone</div></div><div style="font-size: 13.3333px;"><br /><br /></div><div style="font-size: 13.3333px;"><span style="font-weight: bold;">Internet connectivity </span></div><div style="font-size: 13.3333px;">supplied to RPi via ethernet / Wifi</div><div style="font-size: 13.3333px;"><div style="font-size: 13.3333px;">supplied to phones via Wifi / mobile data</div><div><br /><br /></div></div><div><span style="font-weight: bold;">Usage:</span></div><div><br /><br /></div><div>RPi, boots, and reads a configuration file, containing URL + credentials of MQTT broker, <span style="font-size: 13.3333px;">UUID of previous run.</span></div><div>RPi  checks connection with MQTT broker. </div><div>If a previous run UUID is available, RPi removes it from the MQTT server (security)</div><div>RPi generates run UUID, and saves in config file</div><div><span style="font-size: 10pt;">If all is well, generates QR code containing URL, credentials and run UUID and displays on-screen.</span><br /><br /></div><div><br /><br /></div><div>RPi runs Node-RED service. </div><div>Node-RED service check configuration file for </div><div><ul><li>URL + credentials of MQTT server.<br /><br /></li><li>UUID of current run</li><li>Resource definitions</li><li>Sensor threshold definitions</li></ul></div><div>Node-RED publishes resource definitions under a known topic structure, beginning with the run UUID.</div><div><span style="font-weight: bold;"><br /><br /></span></div><div>Node-RED subscribes to throttle and resource demand topics for each supported channel (track) </div><div>Node-RED starts Python scripts to monitor sensor values against thresholds.</div><div><br /><br /></div><div>Players connect with the game using their smart phone to scan the QR code. </div><div>Their phone will request load of the SPWA. </div><div>SPWA is loaded, and connects with the MQTT broker. </div><div>SPWA is able to publish and subscribe to all values on the MQTT tree.</div><div><br /><br /></div><div><span style="font-size: 10pt;">Using the value PiState, it is able to check that the Pi is ready for interaction</span><br /><br /></div><div>Using the value GameState, it is able to communicate with any other instances of the SPWA, to read and write global game variables, such as whether channels (tracks) are in use.</div><div><br /><br /></div><div>Once the SPWA instance has access to the track, it restricts its throttle demand to a single channel, and can publish this as a percentage. The SPWA subscribes to the throttle value, so that it can react if the demand has not been acknowledged by the Pi.</div><div><br /><br /></div><div><span style="font-weight: bold;">Resources</span></div><div>The SPWA may deploy 'special weapons' as resources. These are published as a list, which specify id, name, description, and icon URLs. The resources can be found in the tree. Publishing a value to a resource id causes it to be deployed. Subscribing delivers the number of resources left.</div><div><span style="font-size: 10pt;"><br /><br /></span></div><div><span style="font-size: 10pt;">The deployment of a resource optionally requires parameters:</span></div><div><ol><li>the target channel</li></ol><div>Some resources require a target channel to be specified; others do not.</div></div><div><br /><br /></div><div>Subscribing to the resource when deployed will give one of 3 values:</div><div><br /><br /></div><div><ol><li>Ready</li><li>Requested</li><li>Busy</li></ol><div><br /><br /></div><div><span style="font-weight: bold;">Events</span></div><div><br /><br /></div><div>A SPWA may subscribe to the Events on its channel (track).</div><div>When a resource deployed to with the channel as a target, the Event is reported, with the id of the resource.</div><div><br /><br /></div><div>Events are reported to all channels if a resource is deployed without a target.</div><div><br /><br /></div><div><span style="font-weight: bold;">Sensors</span></div><div><span style="font-weight: bold;"><br /><br /></span></div><div>A SPWA may subscribe to any one of the sensor channels. Subscribers are updated whenever a sensor is triggered past a threshold.</div><div><br /><br /></div><div>The following sensors are supported:</div><div><ol><li>Current sensor: reports when current has dropped below a threshold. <br /><br /></li><li>Light sensor: reports when light has dropped below a threshold.</li></ol><div>To reset the trigger, the senor value must pass the threshold in the opposite direction.</div></div><div><br /><br /></div><div><br /><br /></div></div><div>Sensor can be used in conjunction with GameState and Throttle to sense when a car is in trouble - for instance in race mode, if there is a demand on the throttle, and the current sensor is triggered: if the race is about to begin, and cars are on their way to the start line. </div><div><br /><br /></div><div><br /><br /></div><div><br /><br /></div><div> </div><div><br /><br /></div><div><br /><br /></div><div><br /><br /></div><div><br /><br /></div><div><br /><br /></div></div></div></div><map name="map_start"><area shape="rect" coords="159,452,280,514" href="#/page/schematic" title="schematic" /></map></div><div class="page" id="schematic"><img src="pages/schematic.png" width="1857" height="1169" usemap="#map_schematic" /><div class="notes"><span class="open control" title="Show Notes">Ξ</span><span class="pin control" title="Pin Notes">∞</span><span class="close control" title="Hide Notes">×</span><div class="content"><div><span style="font-weight: bold;">Scalextric Power</span><div><br /><br /></div><div>The Scalextric power track has been butchered, and connection is made to track in place of the 'M' (motor) in the diagram.</div><div><br /><br /></div><div>Power to 16V, up to 2A is supplied via a benchtop supply. </div><div>The TIP3055 transistor takes a small amount of current from the Raspberry Pi. As a component, it's not really ideal; we really should have one which uses voltage to control output, but this seems to do, and the Pi has no problem supplying enough juice for 2 channels.</div><div><br /><br /></div><div>The diode here is to handle the back EMF from the motor. </div><div><br /><br /></div><div><br /><br /></div><div>See <a href="https://progeny.co.uk/back-emf-suppression/" style="font-size: 13.3333px; font-weight: bold;">https://progeny.co.uk/back-emf-suppression/</a></div><div><br /><br /></div></div></div></div><map name="map_schematic"><area shape="rect" coords="-150,0,1276,891" href="#/page/start" title="start" /></map></div><script type="text/javascript" src="Resources/main.js">
                    //
                </script></body></html>